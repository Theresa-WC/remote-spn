# .github/workflows/archive-pages.yml (ver.7 - 解决并发冲突)

name: '云端归档页面 (Run spn.sh)'

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: '要归档的目标 URL(s)'
        required: true
        type: string
      api_key_choice:
        description: '选择要使用的 API Key'
        required: true
        type: choice
        options:
          - Formal
          - Temp1
          - Temp2
          - Temp3
          - Temp4
        default: 'Temp1'
      spn_args:
        description: 'spn.sh 的其他参数 (例如 -n -w 7 -o ".*")'
        required: false
        default: ''
        type: string

jobs:
  archive:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download and Setup spn.sh
        run: |
          curl -L -o spn.sh https://raw.githubusercontent.com/overcast07/wayback-machine-spn-scripts/main/spn.sh
          chmod +x spn.sh

      - name: Select API Key
        id: set_key
        run: |
          if [[ "${{ inputs.api_key_choice }}" == "Formal" ]]; then
            echo "SELECTED_API_KEY=${{ secrets.SPN_API_KEY_AURORA2378 }}" >> $GITHUB_ENV
          elif [[ "${{ inputs.api_key_choice }}" == "Temp1" ]]; then
            echo "SELECTED_API_KEY=${{ secrets.SPN_API_KEY_DFWHFWE }}" >> $GITHUB_ENV
          elif [[ "${{ inputs.api_key_choice }}" == "Temp2" ]]; then
            echo "SELECTED_API_KEY=${{ secrets.SPN_API_KEY_NGH3U83F9 }}" >> $GITHUB_ENV
          elif [[ "${{ inputs.api_key_choice }}" == "Temp3" ]]; then
            echo "SELECTED_API_KEY=${{ secrets.SPN_API_KEY_BRENDASRIVERA }}" >> $GITHUB_ENV
          elif [[ "${{ inputs.api_key_choice }}" == "Temp4" ]]; then
            echo "SELECTED_API_KEY=${{ secrets.SPN_API_KEY_ERICAPEARSON }}" >> $GITHUB_ENV
          else
            echo "::error::Invalid API Key choice selected."
            exit 1
          fi

      # ====================================================================
      # 新增步骤：在此处显示选择的参数
      # ====================================================================
      - name: Display Selected Parameters
        run: |
          echo "================ Parameters ================"
          echo "  URL to archive: ${{ github.event.inputs.target_url }}"
          echo "  API Key profile: ${{ github.event.inputs.api_key_choice }}"
          echo "  Additional args: ${{ github.event.inputs.spn_args || 'None' }}"
          echo "=========================================="
      # ====================================================================

      - name: Run Archive Script
        id: spn_run
        run: |
          if [ -z "${{ env.SELECTED_API_KEY }}" ]; then
            echo "::error::Selected API_KEY is not available or secret is not configured."
            exit 1
          fi
          # [修改] 忽略 [Status request failed] 警告
          ./spn.sh -a "${{ env.SELECTED_API_KEY }}" ${{ inputs.spn_args }} ${{ inputs.target_url }} | grep --line-buffered -v "Status request failed"

      - name: Prepare Files for Commit
        run: |
          mkdir -p archive_results
          if [ -d "/home/runner/spn-data" ] && [ "$(ls -A /home/runner/spn-data)" ]; then
            cp -r /home/runner/spn-data/* archive_results/
            echo "Files copied to archive_results/ for commit."
          else
            echo "No files generated in /home/runner/spn-data. Nothing to commit."
          fi
      
      # 新增步骤：在提交前拉取最新更改
      - name: Pull latest changes from remote
        run: git pull --rebase

      # 核心步骤：使用 Action 提交更改
      - name: Commit Archive Files to Repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: 归档 ${{ inputs.target_url }} 的结果"
          file_pattern: archive_results/**
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          commit_author: GitHub Actions Bot <github-actions[bot]@users.noreply.github.com>

      # 上传结果文件
      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: spn-results
          path: /home/runner/spn-data
          if-no-files-found: warn
